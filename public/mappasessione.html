<!DOCTYPE html>
<html>
  <head>
    <title>Simple Map</title>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 100%;
        margin: 3px;
      }
      #map2 {
        height: 33%;
        margin: 3px;
      }
      #map3 {
        height: 33%;
        margin: 3px;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <script>

      Array.prototype.max = function() {
        return Math.max.apply(null, this);
      };

      Array.prototype.min = function() {
        return Math.min.apply(null, this);
      };

      function findGetParameter(parameterName) {
          var result = null,
              tmp = [];
          location.search
              .substr(1)
              .split("&")
              .forEach(function (item) {
                tmp = item.split("=");
                if (tmp[0] === parameterName) result = decodeURIComponent(tmp[1]);
              });
          return result;
      }
      var username = findGetParameter("Username");
      var session = findGetParameter("Session");
      var coord = findGetParameter("Coord");
      var limit = findGetParameter("Limit");
      if(typeof (limit) === undefined || limit === null){
        limit = 0.3;
      }
      if(typeof (coord) === undefined || coord === null){
        coord = "x";
      }
      var map;
      
      function initMap() {

        // Get the data from the server.
        var flightPlanCoordinates = [] ;
        var absmax = limit;

        if(typeof (username) != undefined && typeof(session)!= undefined && username != null && session != null){
          $getResult = $.get( "../sessionDetail?Username="+username+"&Session="+session, 
            function(response, err) {
              // manipulate response
              flightPlanCoordinates = response;
          }).done(function() {
            if(flightPlanCoordinates.length>0){
              map = new google.maps.Map(document.getElementById('map'), {
                center: {"lat": flightPlanCoordinates[0].lat, "lng": flightPlanCoordinates[0].lng},
                zoom: 15
              });              
            }else{
              map = new google.maps.Map(document.getElementById('map'), {
                center: {"lat": 41.84655, "lng": 12.62636},
                zoom: 11
              });
            }
            if(coord === 'speed'){
              var speed_val = 0;
              for(i = 1; i < flightPlanCoordinates.length; i++){
                flightPlanCoordinatestemp = [{"lat":flightPlanCoordinates[i-1].lat,"lng":flightPlanCoordinates[i-1].lng},
                {"lat":flightPlanCoordinates[i].lat,"lng":flightPlanCoordinates[i].lng}];
                speed_val = speed(flightPlanCoordinatestemp,flightPlanCoordinates[i-1].Timestamp, flightPlanCoordinates[i].Timestamp);
                //flightPlanCoordinatestemp = flightPlanCoordinates.slice(i, i+2);
                var flightPath = new google.maps.Polyline({
                  path: flightPlanCoordinatestemp,
                  geodesic: true,
                  strokeColor: getRandomColor( Math.abs(flightPlanCoordinates[i][coord]) ),
                  strokeOpacity: 1.0,
                  strokeWeight: 6
                });
                flightPath.setMap(map);
                var midPointMarker = new google.maps.Marker({  
                    position: flightPlanCoordinatestemp[0],  
                    map: map,
                    visible: false  // NB the marker is 'invisible'
                });
                var stuLabel = new Label();
                stuLabel.bindTo('position', midPointMarker, 'position');
                stuLabel.set('text', speed_val + ' Km/h');

                // lets add event listeners
                google.maps.event.addListener(polyline, 'mouseover', function() {
                    stuLabel.setMap(map);
                });

                google.maps.event.addListener(polyline, 'mouseout', function() {
                    stuLabel.setMap(null);
                });
              }
            }else{
              for(i = 1; i < flightPlanCoordinates.length; i++){
                flightPlanCoordinatestemp = [{"lat":flightPlanCoordinates[i-1].lat,"lng":flightPlanCoordinates[i-1].lng},
                {"lat":flightPlanCoordinates[i].lat,"lng":flightPlanCoordinates[i].lng}];
                var flightPath = new google.maps.Polyline({
                  path: flightPlanCoordinatestemp,
                  geodesic: true,
                  strokeColor: getRandomColor( Math.abs(flightPlanCoordinates[i][coord]) ),
                  strokeOpacity: 1.0,
                  strokeWeight: 6
                });
                flightPath.setMap(map);
              }
            }
          });
        }
      }

      function getRandomColor_old(value = -1) {

        var colors = Array("FF0000", "FF1000", "FF2000", "FF3000", "FF4000", "FF5000", "FF6000", "FF7000", "FF8000", "FF9000", "FFA000", "FFB000", "FFC000", "FFD000", "FFE000", "FFF000", "FFFF00", "F0FF00", "E0FF00", "D0FF00", "C0FF00", "B0FF00", "A0FF00", "90FF00", "80FF00", "70FF00", "60FF00", "50FF00", "40FF00", "30FF00", "20FF00", "10FF00");
        
        if(value >= 0 && value < colors.length){
          color = "#"+colors[31-value];
        }else{
          color = "#"+colors[Math.floor(Math.random()*colors.length)];
        }
        return color;
      }
      
      function getRandomColor(value = -1, soglia = 0.3) {
        var colors = Array("00b3fd", "fd9700", "fd0000");
        
        if(value <= 0.1 ){
          color = "#"+colors[0];
        }else{
          if(value <= 0.3){
            color = "#"+colors[1];
          }else{
            color = "#"+colors[2];
          }
        }
        return color;
      }

      function distance(lat1, lon1, lat2, lon2, unit) {
        var radlat1 = Math.PI * lat1/180
        var radlat2 = Math.PI * lat2/180
        var theta = lon1-lon2
        var radtheta = Math.PI * theta/180
        var dist = Math.sin(radlat1) * Math.sin(radlat2) + Math.cos(radlat1) * Math.cos(radlat2) * Math.cos(radtheta);
        dist = Math.acos(dist)
        dist = dist * 180/Math.PI
        dist = dist * 60 * 1.1515
        if (unit=="K") { dist = dist * 1.609344 }
        if (unit=="N") { dist = dist * 0.8684 }
        return dist
      }

      function speed(flightPlanCoordinates, t1, t2){
        return 3600 * distance(flightPlanCoordinates[0].lat, flightPlanCoordinates[0].lng, flightPlanCoordinates[1].lat, flightPlanCoordinates[1].lng, "K")/((t2 - t1));
      }


    // Define the overlay, derived from google.maps.OverlayView
    function Label(opt_options) {
        // Initialization
        this.setValues(opt_options);

        // Label specific
        var span = this.span_ = document.createElement('span');
        span.style.cssText = 'position: relative; left: -50%; top: -8px; ' +
                             'white-space: nowrap; border: 1px solid blue; ' +
                             'padding: 2px; background-color: white';

        var div = this.div_ = document.createElement('div');
        div.appendChild(span);
        div.style.cssText = 'position: absolute; display: none';
    }
    Label.prototype = new google.maps.OverlayView;

    // Implement onAdd
    Label.prototype.onAdd = function() {
        var pane = this.getPanes().overlayLayer;
        pane.appendChild(this.div_);

        // Ensures the label is redrawn if the text or position is changed.
        var me = this;
        this.listeners_ = [
            google.maps.event.addListener(this, 'position_changed',
                function() { me.draw(); }),
            google.maps.event.addListener(this, 'text_changed',
                function() { me.draw(); })
        ];
    };

    // Implement onRemove
    Label.prototype.onRemove = function() {
        this.div_.parentNode.removeChild(this.div_);

        // Label is removed from the map, stop updating its position/text.
        for (var i = 0, I = this.listeners_.length; i < I; ++i) {
            google.maps.event.removeListener(this.listeners_[i]);
        }
    };

    // Implement draw
    Label.prototype.draw = function() {
        var projection = this.getProjection();
        var position = projection.fromLatLngToDivPixel(this.get('position'));

        var div = this.div_;
        div.style.left = position.x + 'px';
        div.style.top = position.y + 'px';
        div.style.display = 'block';

        this.span_.innerHTML = this.get('text').toString();
    };

    </script>
	<script
	  src="..\assets\js\jquery-3.2.1.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDWG_AjxYCOnXkeMl-biHoneHbjktkDA2Y&callback=initMap" async defer></script>
  </body>
  <script>
    
	// You don't need google.maps.event.addDomListener(window, 'load', initialize);
	// if you use jQuery's $(document).ready() function.

	function initialize() {

	}
  </script>
</html>